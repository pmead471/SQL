--CREATE TABLE
CREATE TABLE flightdata
(
	year numeric,
	month numeric,
	dayofmonth numeric,
	dayofweek numeric,
	deptime varchar,
	crsdeptime varchar,
	arrtime varchar,
	crsarrtime varchar,
	unique_carrier varchar,
	flightnum int,
	tailnum varchar,
	actualelapsedtime varchar,
	crselapsedtime varchar,
	airtime varchar,
	arrdelay varchar,
	depdelay varchar,
	origin varchar,
	dest varchar,
	distance varchar,
	taxiin varchar,
	taxiout varchar,
	cancelled int,
	cancellationcode varchar,l
	diverted int,
	carrierdelay varchar,
	weatherdelay varchar,
	NASDelay varchar,
	securitydelay varchar,
	lateaircraftdelay varchar
)
--INSERT INTO

--1

SELECT year, round(avg(cancelled)*100,2) as avg_cancelled
FROM flightdata
WHERE year between 1999 and 2003
GROUP BY year

--2

with cte as
(
	SELECT dayofweek, arrdelay,
	CASE WHEN arrdelay > 0 THEN 1
	ELSE 0 END as arrdelay_pct
	FROM flightdata
	WHERE dest = 'IAH' and origin = 'MCO' and year = 2007
)
SELECT dayofweek, round(avg(arrdelay_pct)*100,2) as avg_delay
FROM cte
GROUP BY dayofweek
ORDER BY avg(arrdelay_pct) DESC

--3

SELECT uniquecarrier, flightnum, origin, dest, concat(month,'/',dayofmonth,'/',year) as date,arrtime, crsarrtime, (crsarrtime-arrtime) as diff
FROM flightdata
WHERE year = 2004 and arrtime is not null
ORDER BY diff DESC
LIMIT 10

--4

with cte as
(
select year, uniquecarrier, avg(actualelapsedtime) as avg_time
from flightdata
WHERE origin = 'ORD' and dest = 'LAX'
GROUP by year, uniquecarrier
ORDER BY avg(actualelapsedtime) DESC
),
cte2 as
(
SELECT year, uniquecarrier, min(avg_time) over(partition by year) as min_avg_time
FROM cte
)
SELECT cte.year, cte.uniquecarrier, cte.avg_time
FROM cte
JOIN cte2 on cte.year = cte2.year and cte.uniquecarrier = cte2.uniquecarrier
WHERE cte.avg_time = cte2.min_avg_time

--5

SELECT year, uniquecarrier, round(avg(carrierdelay)/avg(actualelapsedtime),8)*100 as carrier_delay_ratio
FROM flightdata
WHERE year between 2002 and 2005 and actualelapsedtime > 0
GROUP BY year, uniquecarrier

--6

 SELECT avg(taxiin::double precision) AS taxiinavg,
    avg(taxiout::double precision) AS taxioutavg,
    uniquecarrier
   FROM flightdata
  WHERE taxiin::text <> 'NA'::text AND dest::text = 'JFK'::text OR taxiout::text <> 'NA'::text AND origin::text = 'JFK'::text
  GROUP BY uniquecarrier
  ORDER BY (avg(taxiout::double precision)) DESC;

--7

with cte as
(
SELECT origin, dest, 
CASE when arrdelay > 10 THEN 1
ELSE 0 END as chance_arr_delay
FROM flightdata
WHERE year = 2005 and month = 12
)
SELECT origin, dest, round(avg(chance_arr_delay)*100,4)
FROM cte
GROUP BY origin, dest
HAVING count(*) > 20
ORDER BY avg(chance_arr_delay) DESC
LIMIT 10

--8

with cte as
(
SELECT year, 
AVG(CASE WHEN arrdelay > 0 THEN 0
ELSE 1 END) as pct_on_time
FROM flightdata
WHERE year between 2000 and 2007 and uniquecarrier = 'WN'
GROUP BY year
)

SELECT *, (LAG(pct_on_time,1,pct_on_time) OVER(ORDER BY year)) as previous, (pct_on_time -(LAG(pct_on_time,1,pct_on_time) OVER(ORDER BY year)))/(LAG(pct_on_time,1,pct_on_time) OVER(ORDER BY year)) as yoy_change
FROM cte

--9

WITH cte as
(SELECT dayofmonth, month, 
 	cast(concat(month,'/',dayofmonth,'/',2005) as date) as date,
	AVG(CASE WHEN arrdelay > 0 THEN 0 ELSE 1 END) as pct_on_time
FROM flightdata
WHERE year = 2005 and month in (8,9) and uniquecarrier = 'UA'
GROUP BY month, dayofmonth
ORDER by month, dayofmonth
)

SELECT *, 
	(SELECT AVG(cte2.pct_on_time)
	FROM cte as cte2
	WHERE cte2.date between cte.date-30 and cte.date)
FROM cte
